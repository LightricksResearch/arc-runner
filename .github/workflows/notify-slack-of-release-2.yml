name: Check Actions Runner Release

on:
  # schedule:
  #   - cron: '0 9 1 */2 *'  # Every 2 months on the 1st at 9 AM UTC
  # workflow_dispatch:
  push:
    branches:
      - '**'

jobs:
  check-runner-release:
    runs-on: ubuntu-latest
    env:
      DOCKERFILE_PATH: 'images/Dockerfile'
    steps:
      - name: Check for new runner release
        id: check_release
        run: |
          #!/bin/bash
          set -euo pipefail
          
          echo "ðŸ” Checking for new actions/runner release..."
          
          # Get latest release
          LATEST=$(curl -s https://api.github.com/repos/actions/runner/releases/latest)
          
          TAG=$(echo "$LATEST" | jq -r '.tag_name')
          URL=$(echo "$LATEST" | jq -r '.html_url')
          PUBLISHED=$(echo "$LATEST" | jq -r '.published_at')
          
          echo "RUNNER_VERSION: $TAG"
          echo "Published on: $PUBLISHED"
          
          # Check if new (last 3 months = 90 days)
          PUBLISHED_TS=$(date -d "$PUBLISHED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$PUBLISHED" +%s)
          CURRENT_TS=$(date +%s)
          AGE_SECONDS=$((CURRENT_TS - PUBLISHED_TS))
          THREE_MONTHS_SECONDS=$((90 * 24 * 60 * 60))  # 90 days in seconds
          
          AGE_DAYS=$((AGE_SECONDS / 86400))
          
          echo "Release age: $AGE_DAYS days"
          
          if [ $AGE_SECONDS -lt $THREE_MONTHS_SECONDS ]; then
            echo "âœ… Release is less than 3 months old (${AGE_DAYS} days)"
            IS_NEW="true"
          else
            echo "â„¹ï¸  Release is older than 3 months (${AGE_DAYS} days)"
            IS_NEW="false"
          fi
          
          # Get Dockerfile values
          echo "ðŸ“„ Fetching Dockerfile arguments for actions runner version $TAG..."
          RUNNER_NEW_DOCKERFILE=$(curl -s https://raw.githubusercontent.com/actions/runner/main/images/Dockerfile)
          
          HOOKS_VERSION=$(echo "$RUNNER_NEW_DOCKERFILE" | grep 'ARG RUNNER_CONTAINER_HOOKS_VERSION' | cut -d'=' -f2)
          DOCKER_VERSION=$(echo "$RUNNER_NEW_DOCKERFILE" | grep 'ARG DOCKER_VERSION' | cut -d'=' -f2)
          BUILDX_VERSION=$(echo "$RUNNER_NEW_DOCKERFILE" | grep 'ARG BUILDX_VERSION' | cut -d'=' -f2)
          
          echo "Change the rest of the runner Dockerfile arguments to the following values if needed:"
          echo "RUNNER_CONTAINER_HOOKS_VERSION: $HOOKS_VERSION"
          echo "DOCKER_VERSION: $DOCKER_VERSION"
          echo "BUILDX_VERSION: $BUILDX_VERSION"
          
          # Set outputs
          {
            echo "is_new=$IS_NEW"
            echo "runner_version=$TAG"
            echo "url=$URL"
            echo "age_days=$AGE_DAYS"
            echo "published=$PUBLISHED"
            echo "hooks_version=$HOOKS_VERSION"
            echo "docker_version=$DOCKER_VERSION"
            echo "buildx_version=$BUILDX_VERSION"
          } >> $GITHUB_OUTPUT
      
      - uses: actions/checkout@v5
        if: steps.check_release.outputs.is_new == 'true'
        with:
          sparse-checkout: |
            ${{ env.DOCKERFILE_PATH }}
          sparse-checkout-cone-mode: false

      - name: Update Dockerfile arguments
        id: update_dockerfile
        if: steps.check_release.outputs.is_new == 'true'
        run: |
          DOCKERFILE="${{ env.DOCKERFILE_PATH }}"
           
          echo "ðŸ“„ Reading current values from $DOCKERFILE..."
          
          CURRENT_VERSION=$(grep '^ARG RUNNER_VERSION=' "$DOCKERFILE" | cut -d'=' -f2)
          CURRENT_HOOKS=$(grep '^ARG RUNNER_CONTAINER_HOOKS_VERSION=' "$DOCKERFILE" | cut -d'=' -f2)
          CURRENT_DOCKER=$(grep '^ARG DOCKER_VERSION=' "$DOCKERFILE" | cut -d'=' -f2)
          CURRENT_BUILDX=$(grep '^ARG BUILDX_VERSION=' "$DOCKERFILE" | cut -d'=' -f2)

          echo "Current RUNNER_VERSION: $CURRENT_VERSION"
          echo "Current RUNNER_CONTAINER_HOOKS_VERSION: $CURRENT_HOOKS"
          echo "Current DOCKER_VERSION: $CURRENT_DOCKER"
          echo "Current BUILDX_VERSION: $CURRENT_BUILDX"
          
          echo "ðŸ”„ Updating Dockerfile arguments..."
          
          # Update the Dockerfile
          sed -i \
            -e "s/^ARG RUNNER_VERSION=.*/ARG RUNNER_VERSION=${{ steps.check_release.outputs.runner_version }}/" \
            -e "s/^ARG RUNNER_CONTAINER_HOOKS_VERSION=.*/ARG RUNNER_CONTAINER_HOOKS_VERSION=${{ steps.check_release.outputs.hooks_version }}/" \
            -e "s/^ARG DOCKER_VERSION=.*/ARG DOCKER_VERSION=${{ steps.check_release.outputs.docker_version }}/" \
            -e "s/^ARG BUILDX_VERSION=.*/ARG BUILDX_VERSION=${{ steps.check_release.outputs.buildx_version }}/" \
            "$DOCKERFILE"
      
      # - name: Send Slack notification
      #   if: steps.check_release.outputs.is_new == 'true'
      #   run: |
      #     cat << EOF > message.json
      #     {
      #       "text": "ðŸš€ New GitHub Actions Runner Release: ${{ steps.check_release.outputs.runner_version }} (${{ steps.check_release.outputs.age_days }} days old)",
      #       "blocks": [
      #         {
      #           "type": "header",
      #           "text": {
      #             "type": "plain_text",
      #             "text": "ðŸš€ New Actions Runner Release: ${{ steps.check_release.outputs.runner_version }}"
      #           }
      #         },
      #         {
      #           "type": "section",
      #           "text": {
      #             "type": "mrkdwn",
      #             "text": "A new version of GitHub Actions Runner has been released!"
      #           }
      #         },
      #         {
      #           "type": "section",
      #           "fields": [
      #             {
      #               "type": "mrkdwn",
      #               "text": "*Version:*\n${{ steps.check_release.outputs.runner_version }}"
      #             },
      #             {
      #               "type": "mrkdwn",
      #               "text": "*Published:*\n${{ steps.check_release.outputs.age_days }} days ago"
      #             },
      #             {
      #               "type": "mrkdwn",
      #               "text": "*Release Date:*\n${{ steps.check_release.outputs.published }}"
      #             },
      #             {
      #               "type": "mrkdwn",
      #               "text": "*Release Notes:*\n<${{ steps.check_release.outputs.url }}|View on GitHub>"
      #             }
      #           ]
      #         },
      #         {
      #           "type": "divider"
      #         },
      #         {
      #           "type": "section",
      #           "text": {
      #             "type": "mrkdwn",
      #             "text": "*ðŸ“‹ Action Required:*\nPlease update the following arguments in the runner Dockerfile:"
      #           }
      #         },
      #         {
      #           "type": "section",
      #           "fields": [
      #             {
      #               "type": "mrkdwn",
      #               "text": "*RUNNER_VERSION:*\n\`${{ steps.check_release.outputs.runner_version }}\`"
      #             },
      #             {
      #               "type": "mrkdwn",
      #               "text": "*RUNNER_CONTAINER_HOOKS_VERSION:*\n\`${{ steps.check_release.outputs.hooks_version }}\`"
      #             },
      #             {
      #               "type": "mrkdwn",
      #               "text": "*DOCKER_VERSION:*\n\`${{ steps.check_release.outputs.docker_version }}\`"
      #             },
      #             {
      #               "type": "mrkdwn",
      #               "text": "*BUILDX_VERSION:*\n\`${{ steps.check_release.outputs.buildx_version }}\`"
      #             }
      #           ]
      #         },
      #         {
      #           "type": "actions",
      #           "elements": [
      #             {
      #               "type": "button",
      #               "text": {
      #                 "type": "plain_text",
      #                 "text": "ðŸ“‹ Release Notes"
      #               },
      #               "url": "${{ steps.check_release.outputs.url }}",
      #               "style": "primary"
      #             },
      #             {
      #               "type": "button",
      #               "text": {
      #                 "type": "plain_text",
      #                 "text": "ðŸ“„ View Dockerfile"
      #               },
      #               "url": "https://github.com/actions/runner/blob/main/images/Dockerfile"
      #             }
      #           ]
      #         }
      #       ]
      #     }
      #     EOF
          
      #     curl -X POST \
      #       -H 'Content-Type: application/json' \
      #       -d @message.json \
      #       "${{ secrets.SLACK_WEBHOOK_URL }}"
          
      #     echo "âœ… Slack notification sent!"
      
      - name: Log old release
        if: steps.check_release.outputs.is_new == 'false'
        run: |
          echo "â„¹ï¸  Latest release ${{ steps.check_release.outputs.runner_version }} is ${{ steps.check_release.outputs.age_days }} days old (> 90 days)"
          echo "No notification sent."